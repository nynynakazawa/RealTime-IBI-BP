# 今週の進捗サマリー

## 1. 血圧予測モデル評価（BP_Analysis）

### 結果
- **SBP予測**: SinBP_Dが最適（MAPE 14.50%, RMSE 18.98 mmHg）
- **DBP予測**: RealTimeBPが最適（MAPE 25.39%, RMSE 24.12 mmHg）
- 3手法（RealTimeBP, SinBP_D, SinBP_M）を比較評価し、係数をJSON形式で出力完了

### プログラムの主要処理
1. **データ前処理（run_full_pipeline.py）**:
   - Smartphone/Training_DataのCSVとCNAP beatsデータを読み込み
   - 最後の60秒分に正規化し、タイムスタンプ同期でref_SBP/ref_DBPを補完
   - **外れ値除去の基準**:
     - 0の値を除去（計測エラー）
     - 生理学的範囲外: SBP 60-200 mmHg、DBP 40-150 mmHg を除去
     - 統計的外れ値: 被験者ごとに平均±3σ（Zスコア>3.0）を超える値を除去
     - 時系列的外れ値: 前後の平均値との差が3σ以上となる値を除去
   - 全セッションのデータを結合して学習用データセット作成
2. **モデル学習・評価（train_bp_models.py）**:
   - 3手法（RealTimeBP: 4特徴量、SinBP_D: 6特徴量、SinBP_M: 4特徴量）を評価
   - **クロスバリデーション**:
     - **GroupKFold**: 被験者IDでグループ分けし、同じ被験者のデータが訓練とテストに分かれないように分割（被験者間の汎化性能を評価）
     - **TimeSeriesSplit**: 時系列順に分割し、過去のデータで訓練、未来のデータでテスト（時系列の汎化性能を評価）
   - **Ridge回帰による係数再学習**:
     - 特徴量を標準化（平均0、分散1）してから学習
     - RidgeCVで最適な正則化パラメータ（alpha）を自動選択し、過学習を防止
     - 各フォールドで係数を学習し、全フォールドの平均値を最終係数として採用
   - MAPE、MAE、RMSEを算出し、各フォールドの結果を集計
   - 係数をJSON形式で出力（Android実装用）

### 実装準備
- Android実装用の係数ファイル（`coefficients_SBP_*.json`, `coefficients_DBP_*.json`）を生成

---

## 2. 波形評価システム構築（Waveform_Analysis）

### 実装内容
- 指先リファレンス波形（409.6 Hz）とスマホ波形（30 Hz）の比較評価スクリプトを開発
- 外れ値除去、0-10正規化、スケーリング調整を実装
- 散布図・Bland-AltmanプロットをSVG形式で自動生成

### プログラムの主要処理
1. **データ読み込み**: Finger（.txt）とSmartphone（.csv）の波形データを読み込み
2. **外れ値除去**: 修正Zスコア（MADベース、閾値3.5）で外れ値を検出し、線形補間で補完
3. **正規化**: 各チャネルを0-10の範囲に線形正規化
4. **時間軸整列**: 指先波形をスマホの時間軸に線形補間
5. **スケーリング**: 参照波形の振幅レンジに合わせてスマホ波形を調整
6. **評価指標算出**: MAPE、MAE、RMSE、Bias、相関係数を計算
7. **可視化**: 散布図（回帰直線・係数表示）とBland-AltmanプロットをSVG出力

### 評価結果（W1+W3, 3594サンプル）
- **SinWave**: MAPE 18.22%, MAE 1.82, 相関 0.19（良好）
- **Green**: MAPE 29.71%, MAE 2.97, 相関 0.07（要改善）

### 課題
- Greenチャネルはバイアス補正が必要（セッション依存の正負オフセット）

---

## まとめ
- 血圧予測モデルの評価完了、実装用係数ファイル準備完了
- 波形評価システム構築完了、SinWaveチャネルが良好な性能を確認

