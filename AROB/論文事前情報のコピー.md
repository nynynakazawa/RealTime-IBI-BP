# BP計測に関する修士論文 - 事前情報まとめ

## 1. 論文の概要

### 1.1 タイトル
可視カメラ 30fps 環境の PPG に最適化した非対称サイン波モデル残差に基づく血圧推定

### 1.2 研究の目的
スマートフォン可視カメラ由来の擬似PPGに対し、周波数分解に依存しない「最小モデル残差」による血圧推定（SinBP）を提案する。30fpsという低FPS・高ノイズ条件でも安定した血圧推定を実現する。

### 1.3 研究の貢献
1. 非対称サイン波基準の定義と、E・E√A（Stiffness_sin）に基づく推定枠組み
2. IBI同期（拍ごとにT=IBI）かつピーク整合（位相探索）による比較可能な正規化
3. 同一データ・同一前処理での対照実験計画（ベースライン群・アブレーション・統計計画）
4. 30fps/可視カメラ前提の再現性重視プロトコル（交差検証・前登録・コード/閾値固定方針）

---

## 2. 既存のアブストラクトの内容

### 2.1 要旨
スマートフォン可視カメラ由来の擬似PPGに対し、周波数分解に依存しない「最小モデル残差」による血圧推定（SinBP）を提案する。1拍波形を「生理学的非対称サイン波モデル」＋平均で近似し、残差RMSを歪み指標Eとして定式化、さらにE√A（Stiffness_sin）により血管硬さを定量化する。非対称サイン波モデルは「ピーク→谷が周期の2/3、谷→次ピークが1/3」となる位相写像で構成し、各拍のIBIに同期させ、データ駆動の位相探索により理想波のピークを実測ピークに整合させる。階層三段推定（A・HR → relTTP（谷→山・山→谷）・Stiffness_sin → E）で、30fpsという低FPS・高ノイズ条件でも安定化を図る。

本研究は同一データでの厳密な対照実験計画を含むRegistered-Report（Stage-1）形式で提示し、再現可能な前登録済み解析計画として公開する。

### 2.2 序論の要点
- 連続的な非侵襲血圧モニタリングの需要は高いが、スマートフォン可視カメラのPPGは低SNR・30fpsという制約が大きい
- 従来の高調波比・THD・A₂/A₁等の周波数分解前提手法は、位相ゆらぎや照明変動に弱い
- 本研究は生理的に妥当な非対称一峰波形を基準とし、基準からの外れ（最小モデル残差）を一次特徴化することで、低FPS条件での堅牢な推定を目指す

---

## 3. 実装済みの手法の詳細

### 3.1 システム全体の構成

#### 3.1.1 データ取得フロー
```
Camera X API (30fps, 240×180解像度)
  ↓
ImageAnalysis (ImageProxy)
  ↓
YUV_420_888形式
  ↓
Green値抽出 (Uプレーンから、周辺領域の平均値)
  ↓
BaseLogic処理
  ├─ ピーク検出
  ├─ IBI計算
  └─ 特徴量抽出 (V2P_relTTP, P2V_relTTP, Amplitude)
  ↓
3つのBP推定器に並行送信
  ├─ RealtimeBP (RTBP)
  ├─ SinBPModel (SinBP(M))
  └─ SinBPDistortion (SinBP(D))
```

#### 3.1.2 共通前処理（BaseLogic）
- **ピーク検出**: 不応期8フレーム、前後比較によるピーク検出
- **IBI計算**: ピーク間隔から計算、範囲チェック（0.25秒～1.2秒）
- **特徴量抽出**:
  - V2P_relTTP: 谷→山の相対Time-To-Peak
  - P2V_relTTP: 山→谷の相対Time-To-Peak
  - V2P_Amplitude: 谷→山の振幅
  - P2V_Amplitude: 山→谷の振幅
- **移動平均**: 10拍分の移動平均を計算

### 3.2 手法1: RTBP (RealtimeBP)

#### 3.2.1 概要
BaseLogicの形態学的特徴量のみを使用したシンプルな線形回帰モデル

#### 3.2.2 特徴量
- A: 振幅（averageValleyToPeakAmplitude）
- HR: 心拍数（60000.0 / smoothedIBI）
- V2P_relTTP: 谷→山の相対TTP
- P2V_relTTP: 山→谷の相対TTP

#### 3.2.3 推定式
```
SBP = C0 + C1*A + C2*HR + C3*V2P_relTTP + C4*P2V_relTTP
DBP = D0 + D1*A + D2*HR + D3*V2P_relTTP + D4*P2V_relTTP
```

#### 3.2.4 現在の係数（仮置き）
- C0=80, C1=0.5, C2=0.1, C3=0.1, C4=-0.1
- D0=60, D1=0.3, D2=0.05, D3=0.05, D4=-0.05

#### 3.2.5 制約
- SBP: 60～200 mmHg
- DBP: 40～150 mmHg

### 3.3 手法2: SinBP(M) (SinBPModel)

#### 3.3.1 概要
Sin波フィットのパラメータ（振幅、位相、平均値）を直接使用した線形回帰モデル

#### 3.3.2 データ処理
- **バッファリング**: 90フレーム（30fps × 3秒）のリングバッファ
- **ピーク検出**: 移動窓最大値検出、不応期500ms
- **Sin波フィット**: 1拍分のデータに対して最小二乗法でSin波をフィット
  - s(t) = mean + A * sin(2πt/T + φ)
  - 64点にリサンプリングしてDFT風の内積計算

#### 3.3.3 特徴量
- A: 振幅（Sin波フィットから取得）
- HR: 心拍数（60000.0 / smoothedIBI）
- Mean: 平均値（Sin波フィットから取得）
- Phi: 位相（Sin波フィットから取得）

#### 3.3.4 推定式
```
SBP = α0 + α1*A + α2*HR + α3*Mean + α4*Phi
DBP = β0 + β1*A + β2*HR + β3*Mean + β4*Phi
```

#### 3.3.5 現在の係数（仮置き）
- α0=90.0, α1=4.5, α2=0.25, α3=0.15, α4=2.0
- β0=65.0, β1=2.8, β2=0.12, β3=0.08, β4=1.2

#### 3.3.6 制約
- SBP: 60～200 mmHg
- DBP: 40～150 mmHg

### 3.4 手法3: SinBP(D) (SinBPDistortion)

#### 3.4.1 概要
非対称サイン波モデルからの残差（歪み指標E）を特徴量として使用した3段階推定モデル

#### 3.4.2 非対称サイン波モデル
- **定義**: ピーク→谷が周期の2/3、谷→次ピークが1/3
- **位相写像**:
  ```
  θ(t) = { (3π/2) · (t'/T)            (0 ≤ t' ≤ 2T/3)
           π + 3π · ((t' − 2T/3)/T)   (2T/3 < t' ≤ T) }
  ```
- **正規化基底**: s_norm(t) = (1 + cos(θ(t) + φ0)) / 2
- **理想波形**: s(t) = mean + A · s_norm(t)

#### 3.4.3 データ処理
- **バッファリング**: 90フレーム（30fps × 3秒）のリングバッファ
- **ピーク検出**: 移動窓最大値検出、不応期500ms
- **1拍遅延処理**: 前の拍のデータを処理（より正確な非対称サイン波モデルを構築）
- **動的な収縮期/拡張期比率**: 各拍ごとに実測データから比率を計算（デフォルト: 1/3:2/3）
- **Sin波フィット**: 1拍分のデータに対してSin波をフィット
- **歪み指標計算**: 非対称サイン波モデルからの残差RMS誤差
  ```
  E = sqrt((1/N) · Σ_n (x[n] − s[n])^2)
  ```

#### 3.4.4 特徴量
- A: 振幅（Sin波フィットから取得）
- HR: 心拍数（60000.0 / smoothedIBI）
- V2P_relTTP: 谷→山の相対TTP（BaseLogicから取得）
- P2V_relTTP: 山→谷の相対TTP（BaseLogicから取得）
- Stiffness_sin: E√A（歪み指標×振幅の平方根）
- E: 歪み指標（RMS誤差）

#### 3.4.5 推定式（3段階推定）
```
【第1段: ベースBP計算】
SBP_base = ALPHA0 + ALPHA1*A + ALPHA2*HR
DBP_base = BETA0 + BETA1*A + BETA2*HR

【第2段: 血管特性補正】
SBP_model = SBP_base + ALPHA3*V2P_relTTP + ALPHA4*P2V_relTTP + ALPHA5*Stiffness_sin
DBP_model = DBP_base + BETA3*V2P_relTTP + BETA4*P2V_relTTP + BETA5*Stiffness_sin

【第3段: 歪み補正】
SBP = SBP_model + ALPHA6*E
DBP = DBP_model + BETA6*E
```

#### 3.4.6 現在の係数（仮置き）
- ALPHA0=80.0, ALPHA1=5.0, ALPHA2=0.3, ALPHA3=5.0, ALPHA4=3.0, ALPHA5=0.1, ALPHA6=0.1
- BETA0=60.0, BETA1=3.0, BETA2=0.15, BETA3=3.0, BETA4=2.0, BETA5=0.05, BETA6=0.05

#### 3.4.7 制約
- SBP >= DBP + 10
- SBP: 60～200 mmHg
- DBP: 40～150 mmHg

### 3.5 3手法の比較

| 項目 | RTBP | SinBP(M) | SinBP(D) |
|------|------|----------|----------|
| **データソース** | BaseLogicの特徴量 | Sin波フィット | Sin波フィット + BaseLogic |
| **ピーク検出** | BaseLogicを使用 | 独自のピーク検出 | 独自のピーク検出 |
| **処理タイミング** | リアルタイム | リアルタイム | 1拍遅延 |
| **特徴量** | A, HR, V2P_relTTP, P2V_relTTP | A, HR, Mean, Phi | A, HR, V2P_relTTP, P2V_relTTP, Stiffness_sin, E |
| **推定方法** | 線形回帰（1段階） | 線形回帰（1段階） | 3段階推定 |
| **非対称性** | なし | なし | あり（動的比率） |
| **歪み指標** | なし | なし | あり（E） |

---

## 4. 実験計画

### 4.1 データ取得（これから実施）

#### 4.1.1 環境設定
- **デバイス**: スマートフォン可視カメラ（30fps）
- **測定方式**: 指腹接触方式
- **照明条件**: 室内/屋外/点滅を層別化
- **その他**: 指圧、スキントーンを層別化

#### 4.1.2 参照値
- **参照デバイス**: 上腕カフ（臨床グレード）で同時計測
- **測定条件**: 測定間隔・体位・安静時間を統一

#### 4.1.3 被験者
- **募集条件**: 年齢/性別/スキントーンが偏らないよう募集
- **除外条件**: 不整脈重度等

#### 4.1.4 倫理
- 同意取得・匿名化・暗号化保存

### 4.2 同一データ・同一前処理の対照実験

#### 4.2.1 基本方針
全手法が同じ拍列・同じ正規化系列を入力する前提で比較。学習/検証の分割は完全共通。

#### 4.2.2 ベースライン手法
すべてIBI同期・ピーク整合・同一特徴抽出窓を使用：

1. **形態学派**: TTP（relTTP：谷→山・山→谷）、HR、S/D、勾配、二次微分指標（RealtimeBP系）
2. **高調波派**: A₂/A₁、THD（最小限の調和数、30fps適合設定）
3. **DCT派**: 低次DCT係数＋Ridge/Lasso
4. **小調和合成**: sin(2πt/T)+α·sin(4πt/T+ψ)
5. **学習基準**: 上記特徴→線形/リッジ。ハイパラは前登録し、検証データでの探索は禁止

#### 4.2.3 アブレーション研究
提案手法（SinBP(D)）の各要素の寄与を定量化：

- **(i) A・HR のみ**: ベースライン
- **(ii) + relTTP（谷→山・山→谷の両方向）**: 血管特性の寄与
- **(iii) + Stiffness_sin（E√A）**: 血管硬さ指標の寄与
- **(iv) + E（最終）**: 歪み指標の寄与

各段での寄与を定量化。

### 4.3 検証設計・統計計画

#### 4.3.1 データ分割
- **主要**: 被験者独立のLOSO（Leave-One-Subject-Out）
- **サブ解析**: K-fold（被験者分割）

#### 4.3.2 評価指標
- **主要指標**: SBP/DBP MAE, MD±SD, Bland–Altman, CCC
- **基準**: 
  - AAMI（|MD|≤5 mmHg かつ SD≤8 mmHg）
  - BHS（≤5/10/15 mmHg の累積比率）

#### 4.3.3 統計検定
- **比較**: 提案法 vs 各ベースラインの二者比較（対応あり）
- **信頼区間**: MD差の95% CI、ブートストラップで頑健CI
- **多重性補正**: Holm法で補正

#### 4.3.4 事前仮説
- **H1**: 提案法は30fps条件において形態/高調波/DCT基準よりMAEが小さい
- **H2**: Stiffness_sin は従来AIと独立寄与を持つ（重回帰の部分相関/分散説明率）
- **H3**: ノイズ・照度・スキントーン層で性能低下が小さい（交互作用が小）

#### 4.3.5 リーク防止
- スケール/正規化/閾値は訓練内のみで決定、検証には適用のみ
- 同一被験者の交差漏れを禁止

### 4.4 ロバスト性試験

#### 4.4.1 ノイズ耐性
ホワイト/低周波ドリフト/照度ゆらぎの合成撹乱

#### 4.4.2 FPS依存
30fps → 24/20fpsサブサンプリングで劣化曲線

#### 4.4.3 モーション
微小動揺の再現（微分エネルギー閾値）

#### 4.4.4 皮膚特性
スキントーン層別のMAE/MD±SD報告

---

## 5. 評価方法

### 5.1 評価指標

#### 5.1.1 MAPE（Mean Absolute Percentage Error）
```
MAPE = (100/n) · Σ|(ŷ_i - y_i) / y_i|
```
- 血圧は正値のため0除算は通常起きないが、参照値が異常に小さいサンプルは除外/Winsorizeを推奨
- 外れ値や極端値に頑健な指標として **sMAPE** や **MAE/RMSE** も併記可

#### 5.1.2 MAE（Mean Absolute Error）
```
MAE = (1/n) · Σ|ŷ_i - y_i|
```

#### 5.1.3 RMSE（Root Mean Squared Error）
```
RMSE = sqrt((1/n) · Σ(ŷ_i - y_i)²)
```

#### 5.1.4 平均誤差（MD: Mean Difference）
```
MD = (1/n) · Σ(ŷ_i - y_i)
```

#### 5.1.5 Bland-Altmanプロット
- 臨床的妥当性の視覚化
- 平均値と差の散布図

#### 5.1.6 CCC（Concordance Correlation Coefficient）
- 一致度の指標

### 5.2 係数の推定方法

#### 5.2.1 方法A: 通常の最小二乗（OLS）
- 利点: 係数が解釈しやすい、実装が簡単
- 欠点: 多重共線性や外れ値に弱い

#### 5.2.2 方法B: 正則化回帰（Ridge/Lasso/ElasticNet）
- 利点: 過学習の抑制、特徴量選択（Lasso）
- 推奨: 内部CVでハイパーパラメータ（αなど）最適化

#### 5.2.3 方法C: 制約付き線形回帰
- 例: 生理的整合性のため「係数は非負」「特定特徴量は負」など符号制約
- scikit-learnの `LinearRegression(positive=true)`（非負）または最小二乗の二次計画問題化（cvxpy等）

#### 5.2.4 方法D: ロバスト回帰（Huber/Quantile）
- 外れ値の影響を低減。MAPE評価前の一次モデルとして有用

### 5.3 実装済みの評価ツール

#### 5.3.1 ファイル構成
- `train_bp_models.py`: 3手法の学習・評価メインスクリプト
- `load_and_preprocess.py`: データ読み込み・前処理スクリプト
- `evaluate_models.py`: 学習済みモデルの評価スクリプト

#### 5.3.2 データ形式
CSVファイルに以下のカラムを含む：
- `timestamp`: タイムスタンプ（ms）
- `subject_id`: 被験者ID
- `ref_SBP`, `ref_DBP`: 連続血圧計の参照値
- `M1_*`: RealTimeBP の特徴量と推定値
- `M2_*`: SinBP_D の特徴量と推定値
- `M3_*`: SinBP_M の特徴量と推定値

#### 5.3.3 評価の流れ
1. データ読み込み・前処理
2. 連続血圧計データの統合（時間同期）
3. データ分割（GroupKFoldまたはTimeSeriesSplit）
4. 各Foldで学習・評価
5. 結果の集計（MAPE、MAE、RMSE、係数など）

---

## 6. 実装状況

### 6.1 完成しているプログラム

#### 6.1.1 Sin近似（Sin波フィット）
- **実装場所**: `SinBPModel.java`, `SinBPDistortion.java`
- **機能**: 
  - 1拍分のデータを64点にリサンプリング
  - DFT風の内積計算でSin波パラメータ（A, φ, mean）を推定
  - 最小二乗法によるフィッティング

#### 6.1.2 歪み算出
- **実装場所**: `SinBPDistortion.java`
- **機能**:
  - 非対称サイン波モデルからの残差を計算
  - RMS誤差として歪み指標Eを算出
  - Stiffness_sin = E√A を計算

#### 6.1.3 Sinをモデルとした線形回帰
- **実装場所**: `SinBPModel.java`, `SinBPDistortion.java`
- **機能**:
  - Sin波パラメータを特徴量として使用
  - 線形回帰による血圧推定
  - 3段階推定（SinBP(D)の場合）

#### 6.1.4 データ記録
- **実装場所**: `GreenValueAnalyzer.java`
- **機能**:
  - 6つのCSVファイルを保存
    - `_元データ.csv`: 経過時間、Green、IBI、Smoothed IBI
    - `_RTBP.csv`: 経過時間、SBP、DBP
    - `_SinBP_M.csv`: 経過時間、SBP、DBP
    - `_SinBP_D.csv`: 経過時間、SBP、DBP
    - `_Wave_Data.csv`: 経過時間、Green、SinWave
    - `_Training_Data.csv`: 全特徴量と推定値

### 6.2 未実施の作業

#### 6.2.1 線形回帰の精度向上
- **現状**: 係数は仮置き（手動設定）
- **今後**: 実データを用いた係数の再学習
  - OLS、Ridge、Lasso、ElasticNet、Huber回帰など複数の手法を試行
  - 交差検証による最適な手法の選択
  - 係数のAndroid実装への反映

#### 6.2.2 誤差検定
- **現状**: 評価方法は設計済みだが、実データでの評価は未実施
- **今後**: 
  - 連続血圧計との比較評価
  - MAPE、MAE、RMSE、Bland-Altmanプロットの作成
  - AAMI/BHS基準との比較
  - 統計検定の実施

#### 6.2.3 データ取得
- **現状**: データ取得プロトコルは設計済み
- **今後**: 
  - 被験者募集
  - データ取得の実施
  - データの前処理・クリーニング

---

## 7. 論文の構成（予定）

### 7.1 章立て
1. **序論**
   - 背景と動機
   - 従来研究の課題
   - 本研究の貢献

2. **手法**
   - 非対称サイン波モデルの定義
   - 歪み指標Eの計算方法
   - 3つの推定手法の詳細
   - 前処理と正規化

3. **実験計画**
   - データ取得プロトコル
   - 対照実験の設計
   - 統計計画

4. **結果**
   - 3手法の比較結果
   - アブレーション研究の結果
   - ロバスト性試験の結果
   - ベースライン手法との比較

5. **考察**
   - 結果の解釈
   - 手法の優位性
   - 限界と今後の課題

6. **結論**
   - 本研究のまとめ
   - 今後の展望

### 7.2 付録
- 実装の詳細
- 評価指標の詳細
- 統計検定の詳細

---

## 8. 今後の作業計画

### 8.1 短期（データ取得前）
- [ ] データ取得プロトコルの最終確認
- [ ] 倫理審査の申請（必要に応じて）
- [ ] 被験者募集の準備

### 8.2 中期（データ取得中）
- [ ] データ取得の実施
- [ ] データの前処理・クリーニング
- [ ] 連続血圧計データとの同期

### 8.3 長期（データ取得後）
- [ ] 線形回帰の係数再学習
  - [ ] 複数の回帰手法の試行
  - [ ] 交差検証による最適手法の選択
  - [ ] 係数のAndroid実装への反映
- [ ] 誤差検定の実施
  - [ ] MAPE、MAE、RMSEの計算
  - [ ] Bland-Altmanプロットの作成
  - [ ] AAMI/BHS基準との比較
  - [ ] 統計検定の実施
- [ ] アブレーション研究の実施
- [ ] ロバスト性試験の実施
- [ ] 論文執筆

---

## 9. 参考文献・関連資料

### 9.1 プロジェクト内のドキュメント
- `Abstract_SinBP.md`: アブストラクトの内容
- `BP_Calculation_Flow.md`: BP計算フローの詳細
- `BP_MAPE_Evaluation_Methods.md`: MAPE評価方法の詳細
- `Analysis/BP_Analysis/README.md`: 評価ツールの使用方法

### 9.2 実装ファイル
- `app/src/main/java/com/nakazawa/realtimeibibp/BaseLogic.java`: 共通処理
- `app/src/main/java/com/nakazawa/realtimeibibp/RealtimeBP.java`: RTBP実装
- `app/src/main/java/com/nakazawa/realtimeibibp/SinBPModel.java`: SinBP(M)実装
- `app/src/main/java/com/nakazawa/realtimeibibp/SinBPDistortion.java`: SinBP(D)実装
- `app/src/main/java/com/nakazawa/realtimeibibp/GreenValueAnalyzer.java`: データ記録

### 9.3 評価ツール
- `Analysis/BP_Analysis/train_bp_models.py`: 学習・評価スクリプト
- `Analysis/BP_Analysis/load_and_preprocess.py`: データ前処理スクリプト
- `Analysis/BP_Analysis/evaluate_models.py`: 評価スクリプト

---

## 10. 注意事項

### 10.1 係数の仮置きについて
現在、3手法すべての係数は仮置き（手動設定）です。実データを用いた係数の再学習が必要です。

### 10.2 評価の実施について
評価方法は設計済みですが、実データでの評価は未実施です。データ取得後に実施予定です。

### 10.3 論文の言語について
- **フォーマット**: 英語
- **執筆**: 最初は日本語で執筆し、後で英語に翻訳

### 10.4 再現性について
- 前登録: 分割、ハイパラ、除外規則、主要/副次評価項目を固定
- コード: 前処理・特徴抽出・学習・統計の完全スクリプト化（乱数種固定）
- 成果物: 解析ログ、分割リスト、推定値CSV、Bland–Altmanプロットを一括保存

---

**作成日**: 2024年
**最終更新**: 2024年
**ステータス**: 事前情報の整理完了（論文執筆前）

